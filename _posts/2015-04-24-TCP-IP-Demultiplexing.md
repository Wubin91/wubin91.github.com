---
layout: post
category: Linux高性能服务器编程
title: TCP/IP协议详解-分用
tags: [TCP/IP,Network]
tagline: by wubin
---

当帧到达目的主机时，将沿着协议栈自底向上依次传递。各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，并最终将处理后的帧交给目标应用程序。这个过程称为分用（demultiplexing）。分用是依靠头部信息中的类型字段实现的。标准文档RFC 1700定义了所有标识上层协议的类型字段以及每个上层协议对应的数值。下图显示了以太网帧的分用过程：

<!--more-->

![以太网帧的分用过程](/img/The-Process-of-Ethernet-Frame-Demultiplexing.png)

因为IP协议、ARP协议和RARP协议都使用帧传输数据，所以帧的头部需要提供某个字段（具体情况取决于帧的类型）来区分它们。以以太网帧为例，它使用2字节的类型字段来标识上层协议。

* 如果主机接收到的以太网帧类型字段的值为0x800，则帧的数据部分为IP数据报，以太网驱动程序就将帧交付给IP模块；
* 若类型字段的值为0x806，则帧的数据部分为ARP请求或应答报文，以太网驱动程序就将帧交付给ARP模块；
* 若类型字段的值为0x835，则帧的数据部分为RARP请求或应答报文，以太网驱动程序就将帧交付给RARP模块。

同样，因为ICMP协议、TCP协议和UDP协议都使用IP协议，所以IP数据报的头部采用16位的协议字段来区分它们。

TCP报文段和UDP数据报则通过其头部中的16位的端口号（port number）字段来区分上层应用程序。比如DNS协议对应的端口号是53，HTTP协议（Hyper-Text Transfer Protocol，超文本传输协议）对应的端口号是80。所有知名应用层协议使用的端口号都可在`/etc/services`文件中找到。

帧通过上述分用步骤后，最终将封装前的原始数据送至目标服务（上图中的ARP服务、RARP服务、ICMP服务或者应用程序）。这样，在顶层目标服务来看，封装和分用似乎没有发生过。
